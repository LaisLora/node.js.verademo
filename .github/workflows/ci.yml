name: NodeJS API Veracode Scan

on:
  push:
    branches:
      - develop  
  pull_request:
    branches:
      - main 

env:
  caminhoPacote: pacoteVeracode.zip

jobs:
  build-and-scan:
    runs-on: ubuntu-latest
    env:
      BUILD_NUMBER: ${{ github.run_number }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '16.x'

      - name: Install Dependencies
        run: npm install


  Archive_And_Scan:
      needs: build-and-scan
      runs-on: ubuntu-latest
      steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Archive Files
        run: zip -r ${{ env.caminhoPacote }} .
      

      - name: Run Veracode Pipeline Scan
        if: success()  # Only run if previous steps succeeded
        env:
          VERACODE_API_ID: ${{ secrets.VERACODE_API_ID }}
          VERACODE_API_KEY: ${{ secrets.VERACODE_API_KEY }}
        run: |
          curl -sSO https://downloads.veracode.com/securityscan/pipeline-scan-LATEST.zip
          unzip pipeline-scan-LATEST.zip
          java -jar pipeline-scan.jar -vid $VERACODE_API_ID -vkey $VERACODE_API_KEY -f ${{ env.caminhoPacote }} -fc LOW

  SCA_Scan:
    needs: build-and-scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Veracode SCA Scan
        env:
          VERACODE_API_ID: ${{ secrets.VERACODE_API_ID }}
          VERACODE_API_KEY: ${{ secrets.VERACODE_API_KEY }}
        run: |
          curl -sSO https://downloads.veracode.com/agentbasedscan/veracode-wrapper.zip
          unzip veracode-wrapper.zip
          java -jar VeracodeJavaAPI.jar -action UploadAndScan -vid $VERACODE_API_ID -vkey $VERACODE_API_KEY -createprofile true -appname "${{ github.repository }}" -version "${{ github.run_id }}" -createsandbox false -filepath ${{ env.caminhoPacote }}
