name: NodeJS API Veracode Scan

on:
  workflow_dispatch:
  repository_dispatch:
    types: [test]
env:
  caminhoPacote: pacoteVeracode.zip

jobs:
  build-and-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '12.x'

      - name: Install Dependencies
        run: npm install

      - name: Run Tests
        run: npm test

  Archive_And_Scan:
      needs: build-and-scan
      runs-on: ubuntu-latest
      steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Archive Files
        run: |
          zip -r ${{ env.caminhoPacote }}
      - name: Download Veracode Pipeline Scanner
        run: |
          curl -sSO https://downloads.veracode.com/securityscan/pipeline-scan-LATEST.zip
          unzip pipeline-scan-LATEST.zip

      - name: Run Veracode Pipeline Scan
        env:
          VERACODE_API_ID: ${{ secrets.VERACODE_API_ID }}
          VERACODE_API_KEY: ${{ secrets.VERACODE_API_KEY }}
        run: |
          java -jar pipeline-scan.jar -vid $VERACODE_API_ID -vkey $VERACODE_API_KEY -f node-app.zip
        
